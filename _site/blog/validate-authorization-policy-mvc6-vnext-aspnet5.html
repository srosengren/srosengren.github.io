<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Rosengren.me - Validate authorization policy in MVC6 vnext, asp.net5</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content=" I'm one of those guys that code thingamajigs, sometimes for mobile devices, but mostly for the web using Javascript and css/less. ">

        <meta property="og:type" content="website"/>
        <meta property="og:image" content="http://www.rosengren.me/assets/images/badge.jpg" />
        <meta property="og:description" content=" I'm one of those guys that code thingamajigs, sometimes for mobile devices, but mostly for the web using Javascript and css/less. "/>

        <!--[if lt IE 9]>
           <script>
              document.createElement('nav');
              document.createElement('header');
              document.createElement('section');
              document.createElement('footer');
              document.createElement('article');
              document.createElement('time');
           </script>
        <![endif]-->
        <link rel="stylesheet" href="/assets/styles/rosengren.css">

    </head>
    <body>
      <div class="navbar-menu-toggle" id="menu-toggle">Menu</div>
      <div class="page" id="page">
        <nav class="navbar" id="navbar-menu">
          <div class="navbar-menu collapse">
            <a class="navbar-menu-item navbar-menu-title navbar-menu-item--home" href="/">home</a>
            <a class="navbar-menu-item navbar-menu-item--blog" href="/blog">blog</a>
          </div>
          <span class="navbar-menu navbar-menu-contact collapse">
            <a class="navbar-menu-item navbar-menu-item--linkedin" href="http://www.linkedin.com/in/srosengren" target="_blank">LinkedIn</a>
            <a class="navbar-menu-item navbar-menu-item--twitter" href="https://twitter.com/srrosengren" target="_blank">Twitter</a>
            <a class="navbar-menu-item navbar-menu-item--github" href="https://github.com/srosengren" target="_blank">Github</a>
            <a class="navbar-menu-item navbar-menu-item--mail" href="javascript:;" id="mail-link">Mail</a>
          </span>
        </nav>
        <div class="main-content" id="content">
            <article class="post">
	<header>
		<h1 class="post__title">Validate authorization policy in MVC6 vnext, asp.net5</h1>
		<div class="post__byline">
			<time datetime="2015-07-27 15:30:00 +0200">27 Jul 2015</time>
			development, web, configuration, authorization, mvc6, vnext, and aspnet5
		</div>
	</header>
	<div class="post__content"><h3 id="background">Background</h3>
<p>Asp.net vnext now supports creating authorization policies through code. What this means is that you no longer have to copy paste your role/claim names all over your application (Or build your own system around this). You can instead declare policies in a central place and authorize based on these, allowing for easier/safer refactoring.</p>

<p><a href="https://github.com/blowdart">Barry Dorrans</a> cover how to create/register policies <a href="https://github.com/aspnet/Announcements/issues/22">here</a></p>

<h3 id="the-problem">The “problem”</h3>
<p>What’s missing here is how to check if the current user passes authorization based on the policy in code. I does cover how to validate a policy with the <code>[Authorize(Policy="MyPolicy")]</code> attribute. But in my case I would like to toggle a link in the application based on the policy.</p>

<h3 id="the-solution">The solution</h3>
<p>So how would we write code to toggle this link then? Unfortunately there isn’t something similar to <code>IsInRole()</code> on the <code>User (ClaimsPrincipal)</code> property, Which I guess makes sense.</p>

<p>After digging through some of the <a href="https://github.com/aspnet/Security/">https://github.com/aspnet/Security</a> source code I found that I probably want to get a hold of an instance of <code>IAuthorizationService</code>. While there isn’t one readily available (as in a specific property) on our <code>Context</code>, we can easily get it through <code>Context.RequestServices</code>.</p>

<p>We have to make sure that we’re using <code>Microsoft.AspNet.Authorization</code> and <code>Microsoft.Framework.DependencyInjection</code> in our code (the solution works in both our controller/actions, and .cshtml files).</p>

<p>Meaning that our .cshtml file could look something likes this:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">@using</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">AspNet</span><span class="p">.</span><span class="n">Authorization</span>
<span class="n">@using</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Framework</span><span class="p">.</span><span class="n">DependencyInjection</span>

<span class="n">@if</span><span class="p">(</span><span class="k">await</span> <span class="n">Context</span><span class="p">.</span><span class="n">RequestServices</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IAuthorizationService</span><span class="p">&gt;().</span><span class="n">AuthorizeAsync</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;MyPolicy&quot;</span><span class="p">)){</span>
  <span class="n">@Html</span><span class="p">.</span><span class="n">ActionLink</span><span class="p">(</span><span class="s">&quot;Blocked link&quot;</span><span class="p">,</span><span class="s">&quot;Our blocked action&quot;</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<h3 id="update-a-better-solution-by-barry">UPDATE: A better solution by Barry</h3>
<p>So I tweeted this to Barry (<a href="https://twitter.com/blowdart">@blowdart</a>) to get his input, to which he replied <a href="https://twitter.com/blowdart/status/631098836409159682">“Sort of”</a> (<a href="http://pastebin.com/3pUyHHaX">His solution</a>). What I had missed was that we can now do dependency injection in .cshtml files using <code>@inject</code> which is pretty cool. I had also missed that there’s a sync version of <code>Authorize</code>.</p>

<p>The example would now look something like this:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">@using</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">AspNet</span><span class="p">.</span><span class="n">Authorization</span>

<span class="n">@inject</span> <span class="n">IAuthorizationService</span> <span class="n">AuthorizationService</span>

<span class="nf">@if</span><span class="p">(</span><span class="n">AuthorizationService</span><span class="p">.</span><span class="n">Authorize</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="s">&quot;MyPolicy&quot;</span><span class="p">)){</span>
  <span class="n">@Html</span><span class="p">.</span><span class="n">ActionLink</span><span class="p">(</span><span class="s">&quot;Blocked link&quot;</span><span class="p">,</span><span class="s">&quot;Our blocked action&quot;</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>In his example he also moves the <code>@using</code> and <code>@inject</code> into the <code>_ViewImport.cshtml</code> file which makes the <code>AuthorizationService</code> available in all your views without you having to repeat yourself.</p>
</div>
</article>

<section>


    
    
        
            
                
                <h4>Similar Posts</h4>
                <ul>
                
                <li>
                    <a href="/blog/global-authorization-attribute-filter-mvc6-vnext-aspnet5">Global Authorization attribute filter in MVC6 vnext, asp.net5
                    
                    </a>
                </li>
                
                
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
                
                <li>
                    <a href="/blog/how-to-avoid-committing-secret-application-settings-visualstudio-github-azure">How to avoid committing secret application settings when working with visual studio, github and azure
                    
                    </a>
                </li>
                
                
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
                
                <li>
                    <a href="/blog/custom-cultures-multi-tenant-translations-dotnet">Custom cultures and multi-tenant localizations in .net
                    
                    </a>
                </li>
                
                
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
                
                <li>
                    <a href="/blog/css-boolean-state-using-checkboxes-radios">CSS boolean states using hidden checkboxes and radios
                    
                    </a>
                </li>
                
                
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
                
                <li>
                    <a href="/blog/perfect-height-width-ratio-fluid-layout">Perfect height-width ratio in fluid css layouts
                    
                    </a>
                </li>
                
                
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
                
                <li>
                    <a href="/blog/compact-datatransfer-experiment">Compact datatransfer experiment
                    
                    </a>
                </li>
                
                
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    


    </ul>

</section>
        </div>
        <footer class="footer-content">
          Powered by <a href="http://http://jekyllrb.com/" target="_blank">Jekyll</a>, hosted on <a href="https://github.com/" target="_blank">Github</a>, compiled using <a href="http://www.ruby-lang.org/en/" target="_blank">Ruby</a> and <a href="http://http://python.org/" target="_blank">Python</a> by a <a href="http://www.microsoft.com/net" target="_blank">.NET</a> guy.
        </footer>
      </div>
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-41772613-1', 'rosengren.me');
        ga('send', 'pageview');

        document.getElementById('mail-link').href = 'mailto:' + 'sebastian' + '@' + 'rosengren' + '.me';

        document.getElementById('menu-toggle').addEventListener('click', function(){
          var navbar = document.getElementById('page');
          if(navbar.className.indexOf('drawer--open') > -1){
            navbar.className = navbar.className.replace(' drawer--open','');
          } else {
            navbar.className = navbar.className + ' drawer--open';
          }
        });

        document.getElementById('content').addEventListener('click',function(){
          var navbar = document.getElementById('page');
          if(navbar.className.indexOf('drawer--open') > -1){
            navbar.className = navbar.className.replace(' drawer--open','');
          }
        })
      </script>
    </body>
</html>
