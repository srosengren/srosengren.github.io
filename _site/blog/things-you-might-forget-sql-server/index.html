<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Rosengren.me - Things you might forget how to do in sql (server)</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="My goal has always been to be a “full stack developer” and this is also something that is required of me in my current position. But there used to be a time when a spent most of my energy on the top layers of application, ie UX, APIs and business logic, and less time with SQL. The aim of this post is to document some of the things in SQL Server that I’ve had to learn more than once due to using it to seldom, it should hopefully be stuck in my head by now though. Remembering things I’ve have forgotten isn’t the easiest task, meaning that I’ll be updating this post when I remember something new.

">

        <meta property="og:type" content="article"/>
        <meta property="og:image" content="http://www.rosengren.me/assets/images/badge.jpg" />
        <meta property="og:description" content="My goal has always been to be a “full stack developer” and this is also something that is required of me in my current position. But there used to be a time when a spent most of my energy on the top layers of application, ie UX, APIs and business logic, and less time with SQL. The aim of this post is to document some of the things in SQL Server that I’ve had to learn more than once due to using it to seldom, it should hopefully be stuck in my head by now though. Remembering things I’ve have forgotten isn’t the easiest task, meaning that I’ll be updating this post when I remember something new.

"/>

        <!--[if lt IE 9]>
           <script>
              document.createElement('nav');
              document.createElement('header');
              document.createElement('section');
              document.createElement('footer');
              document.createElement('article');
              document.createElement('time');
           </script>
        <![endif]-->
        <link rel="stylesheet" href="/assets/styles/rosengren.css">

    </head>
    <body>
      <div class="navbar-menu-toggle" id="menu-toggle">Menu</div>
      <div class="page" id="page">
        <nav class="navbar" id="navbar-menu">
          <div class="navbar-menu collapse">
            <a class="navbar-menu-item navbar-menu-title navbar-menu-item--home" href="/">home</a>
            <a class="navbar-menu-item navbar-menu-item--blog" href="/blog">blog</a>
          </div>
          <span class="navbar-menu navbar-menu-contact collapse">
            <a class="navbar-menu-item navbar-menu-item--linkedin" href="http://www.linkedin.com/in/srosengren" target="_blank">LinkedIn</a>
            <a class="navbar-menu-item navbar-menu-item--twitter" href="https://twitter.com/srrosengren" target="_blank">Twitter</a>
            <a class="navbar-menu-item navbar-menu-item--github" href="https://github.com/srosengren" target="_blank">Github</a>
            <a class="navbar-menu-item navbar-menu-item--mail" href="javascript:;" id="mail-link">Mail</a>
          </span>
        </nav>
        <div class="main-content" id="content">
            <article class="post">
	<header>
		<h1 class="post__title">Things you might forget how to do in sql (server)</h1>
		<div class="post__byline">
			<time datetime="2014-08-19 16:20:00 +0200">19 Aug 2014</time>
			sql, sql server, and stratiteq
		</div>
	</header>
	<div class="post__content"><p>My goal has always been to be a “full stack developer” and this is also something that is required of me in my current position. But there used to be a time when a spent most of my energy on the top layers of application, ie UX, APIs and business logic, and less time with SQL. The aim of this post is to document some of the things in SQL Server that I’ve had to learn more than once due to using it to seldom, it should hopefully be stuck in my head by now though. Remembering things I’ve have forgotten isn’t the easiest task, meaning that I’ll be updating this post when I remember something new.</p>

<h2 id="fieldnames-in-select-is-accessible-from-subquery">Fieldnames in select is accessible from subquery</h2>
<p>This is generally a good thing, being able to use a fieldname from your select statement in a subquery. You could for instance write a select like this:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">Table</span> <span class="o">#</span><span class="n">Car</span> <span class="p">(</span>
<span class="n">OwnerId</span> <span class="nb">INT</span><span class="p">,</span>
<span class="n">PlateNumber</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>

<span class="c1">--Fill #Car</span>

<span class="k">SELECT</span> <span class="n">p</span><span class="p">.</span><span class="n">PersonId</span><span class="p">,</span><span class="n">p</span><span class="p">.</span><span class="n">Name</span>
<span class="k">FROM</span> <span class="n">Person</span> <span class="n">p</span>
<span class="k">WHERE</span> <span class="n">p</span><span class="p">.</span><span class="n">PersonId</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">OwnerId</span> <span class="k">FROM</span> <span class="o">#</span><span class="n">Car</span><span class="p">)</span></code></pre></div>

<p>And you would get every person that owns a car.</p>

<p>But this can also bite you in the ass if you’re not carefull, or as in my case, assume too much about your fieldnames. We write the same query again but change the subquery since we assume that the OwnerId field is called PersonId in this table to.</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">Table</span> <span class="o">#</span><span class="n">Car</span> <span class="p">(</span>
<span class="n">OwnerId</span> <span class="nb">INT</span><span class="p">,</span>
<span class="n">PlateNumber</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>

<span class="c1">--Fill #Car</span>

<span class="k">SELECT</span> <span class="n">p</span><span class="p">.</span><span class="n">PersonId</span><span class="p">,</span><span class="n">p</span><span class="p">.</span><span class="n">Name</span>
<span class="k">FROM</span> <span class="n">Person</span> <span class="n">p</span>
<span class="k">WHERE</span> <span class="n">p</span><span class="p">.</span><span class="n">PersonId</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">PersonId</span> <span class="k">FROM</span> <span class="o">#</span><span class="n">Car</span><span class="p">)</span></code></pre></div>

<p>We will now get every row in the Person table since we’re actually comparing Person.PersonId with itself. Not something that should happen too often, but it might if you have a lot of tables that follow a naming convention, and then one table where the fieldname differs.</p>

<h2 id="get-a-list-of-previously-run-queries">Get a list of previously run queries.</h2>
<p>I thought I had lost half a days of work in the most stupid way. I had built a query that I was going to make into a stored procedure, I copied the code from SSMS into a new stored procedure created in Visual studio and saved it to disk, without publishing the DB project to a database. I then closed the query window in SSMS since I was done, I then somehow wrote over the stored procedure file from another query window in SSMS with code that was meant for another sproc, and I thought that was it. Luckily one of my coworkers showed me how to get the last executed queries from a database.</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">deqs</span><span class="p">.</span><span class="n">last_execution_time</span> <span class="k">AS</span> <span class="p">[</span><span class="n">Time</span><span class="p">],</span> <span class="n">dest</span><span class="p">.</span><span class="nb">text</span> <span class="k">AS</span> <span class="p">[</span><span class="n">Query</span><span class="p">],</span> <span class="n">dest</span><span class="p">.</span><span class="o">*</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_exec_query_stats</span> <span class="k">AS</span> <span class="n">deqs</span>
<span class="k">CROSS</span> <span class="n">APPLY</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_exec_sql_text</span><span class="p">(</span><span class="n">deqs</span><span class="p">.</span><span class="n">sql_handle</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dest</span>
<span class="k">WHERE</span> <span class="n">dest</span><span class="p">.</span><span class="n">dbid</span> <span class="o">=</span> <span class="n">DB_ID</span><span class="p">(</span><span class="s1">&#39;DBNAME&#39;</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">deqs</span><span class="p">.</span><span class="n">last_execution_time</span> <span class="k">DESC</span></code></pre></div>

<p>Just replace DBNAME with the name of the database you want to retrieve queries from, and then run it. This also shows that you should be honest about making mistakes, if I had decided to recreate the query without telling anyone then it might have cost me an hour, and might have been a sloppy recreation with hidden bugs, instead it took 5 minutes and I learned something new!</p>

<h2 id="insert-row-into-table-with-only-a-identity-column">Insert row into table with only a IDENTITY column</h2>
<p>There might come a time when you have to do exactly this, it might not happen often, and you may have forgotten how to do it the next time you have to.</p>

<p>You might have a table that look like this</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Counter</span><span class="p">]</span>
  <span class="p">(</span>
    <span class="n">Id</span> <span class="nb">INT</span> <span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span>
  <span class="p">)</span></code></pre></div>

<p>And you might think, “How do I insert into this?” since you can’t do it like this</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Counter</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span> <span class="k">VALUES</span><span class="p">(</span><span class="o">??</span><span class="p">)</span></code></pre></div>

<p>But what you can do is this. This will insert a new row and increment the Id.</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Counter</span> <span class="k">DEFAULT</span> <span class="k">VALUES</span></code></pre></div>

<h2 id="incrementing-identity-column-in-a-transaction-wont-reseed-on-rollback">Incrementing identity column in a transaction won’t reseed on rollback</h2>
<p>This is probably nothing that will ever come up while writing actual code. But I found it while experimenting with something.</p>

<p>Lets say that you have the following table</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Person</span><span class="p">]</span>
  <span class="p">(</span>
    <span class="n">Id</span> <span class="nb">INT</span> <span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">Name</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span>
  <span class="p">)</span></code></pre></div>

<p>And you run the following</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">BEGIN</span> <span class="n">TRANSACTION</span>
	<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Person</span><span class="p">(</span><span class="n">Name</span><span class="p">)</span>
	<span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;Sebastian&#39;</span><span class="p">)</span>
<span class="k">ROLLBACK</span> <span class="n">TRANSACTION</span></code></pre></div>

<p>Then you might expect that the Id column will reseed back to 1 when the rollback is executed, but that isn’t the case. The identity won’t rollback until you call either reseed or truncate</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">DBCC</span> <span class="n">CHECKIDENT</span> <span class="p">(</span><span class="s1">&#39;Person.Id&#39;</span><span class="p">,</span> <span class="n">RESEED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">--The next inserted rows Id column will have the value of 1</span>
<span class="c1">--or</span>
<span class="k">TRUNCATE</span> <span class="k">TABLE</span> <span class="n">Person</span> <span class="c1">--Will delete all rows in the table without logging, and reseed it</span></code></pre></div>
</div>
</article>

<section>


    
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
                
                <h4>Similar Posts</h4>
                <ul>
                
                <li>
                    <a href="/blog/compact-datatransfer-experiment">Compact datatransfer experiment
                    
                    </a>
                </li>
                
                
            
        
    

    
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
                
                <li>
                    <a href="/blog/repurposing-asp-net-solution">Repurpose, rename ASP.NET solution and projects
                    
                    </a>
                </li>
                
                
            
        
    
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
        
            
        
            
                
                <li>
                    <a href="/blog/jquery-data-and-html-data-attributes">Relationship of jQuery data and data- html attributes
                    
                    </a>
                </li>
                
                
            
        
    


    </ul>

</section>
        </div>
        <footer class="footer-content">
          Powered by <a href="http://http://jekyllrb.com/" target="_blank">Jekyll</a>, hosted on <a href="https://github.com/" target="_blank">Github</a>, compiled using <a href="http://www.ruby-lang.org/en/" target="_blank">Ruby</a> and <a href="http://http://python.org/" target="_blank">Python</a> by a <a href="http://www.microsoft.com/net" target="_blank">.NET</a> guy.
        </footer>
      </div>
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-41772613-1', 'rosengren.me');
        ga('send', 'pageview');

        document.getElementById('mail-link').href = 'mailto:' + 'sebastian' + '@' + 'rosengren' + '.me';

        document.getElementById('menu-toggle').addEventListener('click', function(){
          var navbar = document.getElementById('page');
          if(navbar.className.indexOf('drawer--open') > -1){
            navbar.className = navbar.className.replace(' drawer--open','');
          } else {
            navbar.className = navbar.className + ' drawer--open';
          }
        });

        document.getElementById('content').addEventListener('click',function(){
          var navbar = document.getElementById('page');
          if(navbar.className.indexOf('drawer--open') > -1){
            navbar.className = navbar.className.replace(' drawer--open','');
          }
        })
      </script>
    </body>
</html>
